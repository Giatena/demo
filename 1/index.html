<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width/2, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
	<title>电子工单（实验性）</title>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!-- <script src="../libs/ViewUI/4.3.2/iview.min.js"> </script> -->

<!-- import Vue.js -->
<!-- <script src="//vuejs.org/js/vue.min.js"></script> -->
<!-- import stylesheet -->
<!-- <link rel="stylesheet" href="//unpkg.com/view-design/dist/styles/iview.css"> -->
<!-- import iView -->
<!-- <script src="//unpkg.com/view-design/dist/iview.min.js"></script> -->

	<script type="text/javascript">

	// 表单初始化：预置 dbName、version、db、objectStoreName 四个全局变量。
	// function() 内部 var 定义的变量优先级高于全局变量。
	// 数据库名称
	var dbName = 'Tickets';
	// 数据库版本
	var version = 1;
	// 数据库对象，“var db;”对function()内部无效，通过参数传入db对象可行。
	var db;
	// 数据库表名
	var objectStoreName = 'CW';

	// jQuery 事件的 $(document).ready() --> DOM 就绪时被调用，此时相关资源可能并未加载完毕
	$(document).ready(function() {
		// 检查旧离线会话的 Web 缓存
		if(localStorage.formValues) {
			console.log("localStorage.formValues: "+ localStorage.formValues);
			postForm($("#form").attr('action'), localStorage.formValues);
			localStorage.removeItem("formValues");
		}
		
		// jQuery：点击 id=form 的 submit 按钮，执行 function
		$("#form").submit(function(event) {

			// Prevent the form from posting
			event.preventDefault(); 
			
			// Gather values
			var formValues = $(this).serialize();
			var url = $(this).attr('action');
			postForm(url, formValues);
		});
	});
	
	// 完全加载完毕时调用
	window.onload = function(){
		showTime();

		// IndexedDB 支持检测
		var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.msIndexedDB;
		if(indexedDB){
			console.log("浏览器支持IndexedDB");
		}
		else {
			// 弹窗警告
			alert("您的浏览器不支持IndexedDB，可能会影响页面功能。请更新版本或改用支持的浏览器访问，谢谢");
		}

		createDatabase();
	}

	function showTime() {
		var date = new Date();
		var Y = date.getFullYear();
		var M = date.getMonth() + 1			// 由于月份是从0开始计算，所以要加1
		var D = date.getDate();
		var h = date.getHours();
		var m = date.getMinutes();
		var s = date.getSeconds();
		var ms = date.getMilliseconds();	// 取毫秒数（3位）

		if(M < 10) {M = '0'+ M;}			// 当数值为个位数时，在前面加0
		if(D < 10) {D = '0'+ D;}
		if(h < 10) {h = '0'+ h;}
		if(m < 10) {m = '0' + m;}
		if(s < 10) {s = '0' + s;}
		if(ms < 100) {ms = '0' + ms;}

		// console.log(ms);
		// console.log(Year +"." + Month + "." + Dates +" " + Hour+ ":" + Minute + ":" + Second);
		document.getElementById('dateTime').innerHTML = Y + "." + M + "." + D + " " + h + ":" + m + ":" + s + " " + ms;
		document.getElementById('GUID').value = Y + M + D + h + m + s + ms;

		setTimeout('showTime()', 1000);		// 每隔1秒运行一次 showTime()，即获取当前时间戳
	}

	// IDB 数据库初始化，创建[CW]表，将IDB对象赋值给全局变量db
	function createDatabase() {
		// request 返回一个 IDBOpenDBRequest 对象
		// 而我们期望得到的DB对象在其result属性中
		var openRequest = window.indexedDB.open(dbName, version);

		openRequest.onerror = function(err) {
			console.log("创建[" + dbName + "]数据库错误: " + err.target.errorCode);
		};

		openRequest.onsuccess = function(success) {
			console.log("onsuccess：已打开[" + dbName + "]数据库: " + success.target.result);
			// 获取数据库实例对象 db
			db = success.target.result;

			showData();
		};

		// 首次先触发 onupgradeneeded，再触发 onsuccess
		// 或者 window.indexedDB.open 传递的新版本（版本数值要比现在的高）
		openRequest.onupgradeneeded = function(event) {
			console.log("onupgradeneeded：不存在[" + dbName + "]数据库，已自动创建同名数据库");
			
			// 获取数据库实例对象 db
			db = event.target.result;
			
			// 若不存在表“CW”，则执行新建，且主键为“id”
			if (!db.objectStoreNames.contains(objectStoreName)) {
				objectStore = db.createObjectStore(objectStoreName, {
					keyPath: 'id',
					autoIncrement: true
				});
				console.log("onupgradeneeded：已创建[" + objectStoreName + "]表");
				
				// createIndex(indexName, keyPath, objectParameters)，unique 字段是唯一的
				objectStore.createIndex('id', 'id', {
					unique: true    
				});

				objectStore.createIndex('GUID', 'GUID');
				objectStore.createIndex('ticket', 'ticket');
				objectStore.createIndex('train', 'train');
				objectStore.createIndex('compartment', 'compartment');
				objectStore.createIndex('category', 'category');
				objectStore.createIndex('type', 'type');
				objectStore.createIndex('description', 'description');
				objectStore.createIndex('action', 'action');
				objectStore.createIndex('replacement', 'replacement');
			};
		}
	}

	// 弃用？
	function getIDBobject() {

		// 优先返回缓存的数据库实例
		if (db) {
			return db
		};

		// 打开数据库，返回 iDB 对象
		var openRequest = window.indexedDB.open(dbName, version);
		openRequest.onerror = function(err) {
			console.log("getIDBobject()：打开[" + dbName + "]数据库错误: " + err.target.errorCode);
		};
		openRequest.onsuccess = function(success) {
			console.log("getIDBobject()：已打开[" + dbName + "]数据库: " + success.target.result);
			// 获取数据库实例对象，赋值全局变量db为iDB对象
			db = success.target.result;
			console.log("getIDBobject()：" + typeof db);

			// 不在 funciton() 外声明全局变量，可执行本条
			// window.db = success.target.result;
			// console.log("getIDBobject()：" + typeof window.db);

			// showData();
		};
		openRequest.onupgradeneeded = function(event) {
			console.log("全局 onupgradeneeded：不存在[" + dbName + "]数据库，已自动创建同名数据库");
			// 获取数据库实例对象 db
			db = event.target.result;
			
			// 首次载入网页，且无缓存数据库，则执行 createDatabase() 的 onupgradeneeded 部分
			// 本函数是 onupgradeneeded 部分默认无操作，因为目前用不到版本号升级，即更改数据库结构
		}
	}

	</script>

	<script type="text/javascript">
	function postForm(url, formValues) {
		// 表单数据提交服务器或缓存到 localStorage
		if(navigator.onLine) {
			console.log("Online");
	    	$.post(url, formValues, function(data) {
				console.log("Success: "+ data);
			});
		}
		else {
			console.log("Offline");
			if(typeof(Storage) !== "undefined") {
				console.log("Storage supported");
				localStorage.formValues = formValues;
			}
		}
	}

	// 把表单提交的数据转化为字符串
	$.fn.serializeObject = function(formJson) {
		var o = {};
		var a = this.serializeArray();
		$.each(a, function() {
			if (o[this.name] !== undefined) {
				if (!o[this.name].push) {
					o[this.name] = [o[this.name]];
				}
				o[this.name].push(this.value || '');
			} else {
				o[this.name] = this.value || '';
			}
		});
		return o;
	};



	function addData() {
		// serializeObject() 自定义函数 返回字符串型的表单数据，可解决“url化后的中文乱码”的问题
		// JSON.stringify(json对象) --> 把json对象转化为字符串
		var formStr = JSON.stringify($("#form").serializeObject());
		// console.log("form 数据序列化为（形如json的）字符串：" + formStr);
		
		// JSON.parse(字符串) --> 把字符串转json对象
		var formJson = JSON.parse(formStr);
		console.log("formJson 对象以字符串形式打印：" + JSON.stringify(formJson));

		// 事务：对“CW”表进行读写的权限控制
		var transaction = db.transaction(objectStoreName, "readwrite");
		// 对表进行操作
		var objectStore = transaction.objectStore(objectStoreName);
		// 添加数据
		var objectStoreRequest = objectStore.add(formJson);
		objectStoreRequest.onsuccess = function(onsuccess) {
			// onsuccess.target.result 返回“CW”表的“Key”，一般为数字升序
			console.log("onsuccess：已写入表单数据(formJson) " + onsuccess.target.result);
		};
		showData();
	}

	String.prototype.temp = function(obj) {
		return this.replace(/\$\w+\$/gi, function(matchs) {        
			return obj[matchs.replace(/\$/g, "")] || '';
		});
	};

	function showData() {

		db = window.db;
		console.log("showData()：" + typeof db);

		// 元素们
		var eleForm = document.querySelector('#form');
		var eleTbody = document.querySelector('#result tbody');
		var eleStatus = document.getElementById('status');

		// 模板字符内容
		var strTplList = document.getElementById('tplList').innerHTML;

		var logError = function (error) {
			eleStatus.style.display = 'block';
			eleStatus.innerHTML = '<span class="error">'+ error +'</span>';
		}, logInfo = function (info) {
			eleStatus.style.display = 'block';
			eleStatus.innerHTML = '<span class="info">'+ info + '</span>';
		};

		// 最终要展示的HTML数据
		var htmlProjectList = '';

		// 打开对象存储，获得游标列表
		var objectStore = db.transaction(objectStoreName).objectStore(objectStoreName);
		objectStore.openCursor().onsuccess = function(success) {
			// 返回 IDBCursorWithValue 对象
			var cursor = success.target.result;

			// 如果游标没有遍历完，继续下面的逻辑
			if (cursor) {
				htmlProjectList = htmlProjectList + strTplList.temp(cursor.value);
				// 继续下一个游标项
				cursor.continue();
				// 如果全部遍历完毕
			} else {
				logInfo('');
				eleTbody.innerHTML = htmlProjectList;
				
				if (htmlProjectList == '') {
					logInfo('暂无数据');    
				};
			};
		};
	}

	function editData(id, data) {
		// 编辑数据
		var transaction = db.transaction(objectStoreName, "readwrite");
		// 打开已经存储的数据对象
		var objectStore = transaction.objectStore(objectStoreName);
		// 获取存储的对应键的存储对象
		var objectStoreRequest = objectStore.get(id);
		// 获取成功后替换当前数据
		objectStoreRequest.onsuccess = function(event) {
			// 当前数据
			var myRecord = objectStoreRequest.result;
			// 遍历替换
			for (var key in data) {
				if (typeof myRecord[key] != 'undefined') {
					myRecord[key] = data[key];
				}
			}
			// 更新数据库存储数据
			objectStore.put(myRecord);
		};
	}

	function delBotton(id) {
		// 表读写的事务
		var objectStore = db.transaction(objectStoreName, "readwrite").objectStore(objectStoreName);
		// 删除传入id的条目
		var objectStoreRequest = objectStore.delete(id);
		// 删除成功后
		objectStoreRequest.onsuccess = function() {
			showData();
		};
	}

	// 关闭与删除数据库
	function deleteDatabase() {
		db.onversionchange = function() {
			db.close();
		}
		
		// 删除数据库
		var request = window.indexedDB.deleteDatabase(dbName);

		request.onerror = function(err) {
			console.log("删除[" + dbName + "]数据库失败。" + err.target.errorCode);
		}
		request.onsuccess = function(success) {
			console.log("删除[" + dbName + "]数据库成功。" + success.target.result);
			// 工单列表无法重新初始化
			// 检查数据库是否存在，相当于初始化时，检查本地是否存在缓存一样，待添加判断代码
		}
		request.onblocked = function(event) {
			console.log("删除[" + dbName + "]数据库被阻止。");
		}

		showData();
	}

	// 新增数据
	// 数据库名称,对象仓库（表名）,传入的参数
	function insert(dbName, version, objectStoreName, argument) {
		// openRequest 返回一个 IDBOpenDBRequest 对象
		// 而我们期望得到的DB对象在其result属性中
		var openRequest = window.indexedDB.open(dbName, version);

		openRequest.onerror = function(err) {
			console.log("创建数据库错误: " + err.target.errorCode);
		};

		openRequest.onsuccess = function(success) {
			console.log("数据库已打开: " + success.target.result);
			// 获取数据库实例对象 db
			// var db = success.target.result;
			// var objectStore;
			// if (!db.objectStoreNames.contains(objectStoreName)) {
			// 	objectStore = db.createObjectStore('CW', { keyPath: 'id' });
			// 	console.log("没有" + objectStoreName + "表，已创建。");
			// }
		}

		openRequest.onupgradeneeded = function(event) {
			console.log('数据库版本有变化...');
			// 获取数据库实例对象 db
			// var db = event.target.result;
			// // 如果不存在，则新建一张名为“CW”的表，主键自动生成
			// if (!db.objectStoreNames.contains(objectStoreName)) {
			// 	var objectStore = db.createObjectStore(objectStoreName, autoIncrement);
			// 	console.log('没有' + objectStoreName + "表，已创建。");
			// }
			// // 对某个表 进行事务操作的事务权限控制 
			// var transaction = db.transaction(objectStoreName, 'readwrite');
			// // 对表进行操作
			// var objectStore = transaction.objectStore(objectStoreName);
			// console.log(argument);
			// // 使用add方法,此方法是异步的。有success,error事件
			// var add = objectStore.add(argument);

			// // 添加成功的回调函数
			// add.onsuccess = function(e) {
			// 	console.log(e);
			// 	// console.log('向表[' + objectStoreName + ']新增一条数据为[' + argument + ']成功！！');
			// }
			// add.error = function(e) {
			// 	// console.log('向表[' + objectStoreName + ']新增一条数据为[' + argument + ']失败！！');
			// }
		}
	}

	</script>

	<style type="text/css">
	label, 
	/*
	input {
		// 将每个元素置于一个新行。不启用本参数时，可利用 <br> 换行
		display: block;
	}
	*/
	input {
		/*在条目之间创建空间，让页面看起来不会太乱*/
		margin-bottom: 10px;
	}
	</style>

	<script type="text/javascript">
	// 获取单个复选项的值
	function ifchecked() {
		// if ($("#gj").is(":checked")) {
		// 	document.getElementById("gj_data").type = "text";
		// } else {
		// 	document.getElementById("gj_data").type = "hidden";
		// };

		if ($("#gh1-3").is(":checked")) {
			document.getElementById("other_input").type = "text";
			document.getElementById("other_label").innerHTML = "其他：";
			// 在 input 里添加 name="other" 属性以便提交时，能获取到用户输入的值；默认不获取
			// $("#id") 通过 jQuery 操作元素
			$("#other_input").attr("name","other");
		} else {
			document.getElementById("other_input").type = "hidden";
			document.getElementById("other_label").innerHTML = "其他";
			// 移除 input 的 name="other" 属性
			$("#other_input").removeAttr("name");
		};

		if ($("#replacement_1").is(":checked")) {
			formShow();
		} else {
			formHidden();
		};
	}

	function formHidden(id) {
		// 用于“显示”和“隐藏”按钮控制
		if(!id) {
			id = "#gh1";
		}

		// 删除原有 style 属性，并新增隐藏属性
		$(id).removeAttr("style");
		$(id).attr("style", "display:none");
	}

	function formShow(id) {
		// 用于“显示”和“隐藏”按钮控制
		if(!id) {
			id = "#gh1";
		}

		// 删除原有 style 属性，并新增隐藏属性
		$(id).removeAttr("style");
		$(id).attr("style", "width:730px");
		// $("#gh1").removeAttr("style");
		// $("#gh1").attr("style", "width:730px");
	}

	// 如果点击 日期框 基地下拉框 和 序号下拉框 就执行函数 拼贴三项用户输入到 工单项
	// 高级模式下：工单项默认灰色，不可修改
	</script>

</head>

<body>

<!-- 表单传送到服务器的"post.php" -->
<form action="post.php" method="post" id="form">
	<div id="dateTime"></div>
	<br>

	<!-- 获取模糊地理位置，本地日期和拉取服务器工单列表数据，自动生成提示性工单号。并提供一键填入的按钮 -->
	<input type="hidden" name="GUID" id="GUID">

	<label>日期 </label>
	<input type="date" id="date">

	<label>基地 </label>
	<select name="" id="factory">
		<option value="e" selected = "selected"></option>
		<option value="ML">梅陇(ML)</option>
		<option value="SL">石龙(SL)</option>
		<option value="PHT">蒲汇塘(PHT)</option>
		<option value="JYB">江杨北(JYB)</option>
		<option value="FJ">富锦(FJ)</option>
		<option value="FJ">龙阳(LY)</option>
	</select>

	<label>序号 </label>
	<select name="" id="number">
		<option value="e" selected = "selected"></option>
		<option value="1">01</option>
		<option value="2">02</option>
		<option value="3">03</option>
		<option value="4">04</option>
		<option value="5">05</option>
		<option value="6">06</option>
	</select>
	<br>

	<label for="ticket">质保工单：</label>
	<input type="text" name="ticket" id="ticket" placeholder="日期CW_基地_序号">
	<input type="checkbox" name="123" id ="gj">
	<label>高级</label>
	<input type="button" value="判断" id="pd" onclick="ifchecked()">
	<br>

	<label for="train">列车编号：</label>
	<input type="text" name="train" id="train">
	<br>
    
	<label for="compartment">车厢编号：</label>
	<input type="text" name="compartment" id="compartment">
	<br>
    
	<label for="category">故障类别：</label>
	<input type="radio" value="1" name="category" id="category">
	<label>辅逆</label>
	<input type="radio" value="2" name="category" id="category">
	<label>牵引</label>
	<input type="radio" value="3" name="category" id="category">
	<label>列控</label>
	<br>

	<label for="type">故障级别：</label>
	<input type="radio" value="1" name="type" id="type">
	<label>救援</label>
	<input type="radio" value="2" name="type" id="type">
	<label>清客</label>
	<input type="radio" value="3" name="type" id="type">
	<label>掉线</label>
	<input type="radio" value="4" name="type" id="type">
	<label>换表</label>
	<input type="radio" value="5" name="type" id="type">
	<label>无影响</label>
	<input type="radio" value="6" name="type" id="type">
	<label>均修</label>
	<br>

	<!-- web访问，默认宽度；手机访问，自动适配；rows="2" 默认1行，再增加2行 -->
	<label for="description">故障现象：</label>
	<textarea name="description" id="description" cols="80" rows="2"></textarea>
	<br>

	<label for="action">处理经过：</label>
	<textarea name="action" id="action" cols="80" rows="5"></textarea>
	<br><br>

	<label for="replacement">更换或对翻情况：</label>
	<input type="radio" value="1" name="replacement" id="replacement_1">
	<label>更换</label>
	<input type="radio" value="2" name="replacement" id="replacement_2">
	<label>对翻</label>
	<input type="radio" value="3" name="replacement" id="replacement_3">
	<label>无坏件</label>
	<input type="button" value="显示" onclick="formShow()">
	<input type="button" value="隐藏" onclick="formHidden()">
	<br>

	<!-- style='display:none' 通过CSS隐藏元素，且不占位 -->
	<fieldset id="gh1" style='display:none'>
		<legend>更换1</legend>
		<label>名称：</label>
		<input type="text" name="name" style="width:290px;">
		<label>　来源：</label>
		<input type="radio" value="1" name="from" id="from">
		<label>甲供</label>
		<input type="radio" value="2" name="from" id="from">
		<label>电科</label>
		<input type="radio" value="3" name="from" id="gh1-3">
		<label id="other_label" >其他</label>
		<input type="hidden" id="other_input">
		<br>
		<label>旧件：</label>
		<input type="text" name="old" style="width:290px;">
		<label>　好件：</label>
		<input type="text" name="new" style="width:290px;">
		<br>
	</fieldset>

	<br>
	<input type="submit" value="提交">
	<br>
	<input type="reset" value="重置">
	<br>
	<!-- <input type="button" value="缓存" id="idb" onclick="writeIDB()"> -->

	<label for="test">IDB 数据库操作：</label>
	<!-- 创建一个名称为“Tickets”的数据库，版本为“1”；若不存在“CW”表，则新建 -->
	<input type="button" value="初始化" id="xj" onclick="createDatabase('Tickets', 1, 'CW')">
	<input type="button" value="添加一条数据" id="tj" onclick="addData()">
	<input type="button" value="删除" id="sc" onclick="deleteDatabase()">
	<input type="button" value="显示数据" id="xs" onclick="showData()">
	<input type="button" value="删除第一条数据" id="sc" onclick="delBotton(1)">

</form>

<div id="result" class="result">
	<table>
		<thead>
			<tr>
				<th>GUID</th>
				<th>质保工单</th>
				<th>列车编号</th>
				<th>车厢编号</th>
				<th>故障类别</th>
				<th>故障级别</th>
				<th>故障现象</th>
				<th>处理经过</th>
				<th>更换或对翻情况</th>
				<th width="60">操作</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
	<div id="status" class="status">加载中...</div>
</div>

<!-- 列表数据模板 -->
<!-- 表头必须和IDB中保存的数组顺序一致，否则显示出来的效果会错行 -->
<script id="tplList" type="text/template">
<tr>
	<td data-key="GUID" data-id="$id$" contenteditable="plaintext-only">$GUID$</td>
	<td data-key="ticket" data-id="$id$" contenteditable="plaintext-only">$ticket$</td>
	<td data-key="train" data-id="$id$" contenteditable="plaintext-only">$train$</td>
	<td data-key="compartment" data-id="$id$" contenteditable="plaintext-only">$compartment$</td>
	<td data-key="category" data-id="$id$" contenteditable="plaintext-only">$category$</td>
	<td data-key="type" data-id="$id$" contenteditable="plaintext-only">$type$</td>
	<td data-key="description" data-id="$id$" contenteditable="plaintext-only">$description$</td>
	<td data-key="action" data-id="$id$" contenteditable="plaintext-only">$action$</td>
	<td data-key="replacement" data-id="$id$" contenteditable="plaintext-only">$replacement$</td>
	<td><a href="javascript:" role="button" class="jsListDel" data-id="$id$">删除</a></td>
</tr></script>

</body>

<script type="text/javascript">
	// 删除事件（按钮）
	var eleTbody = document.querySelector('#result tbody');
	eleTbody.addEventListener('click', function (event) {
		console.log("“删除”按钮被点击了");
		var eleBtn = event.target, id = '';
		console.log(eleBtn);
		console.log(eleBtn.classList.contains('jsListDel'));
		console.log(eleBtn.getAttribute('data-id'));
		// if (eleBtn && eleBtn.classList.contains('jsListDel') && (id = eleBtn.getAttribute('data-id'))) {
		if (eleBtn && eleBtn.classList.contains('jsListDel') && (id = eleBtn.getAttribute('data-id'))) {
			delBotton(id * 1);
		event.preventDefault();
		};
	});

    // 编辑事件
    eleTbody.addEventListener('focusout', function (event) {
    	console.log("运行到“编辑事件”");
        var eleTd = event.target;
        // 获取id，也就是获得主键
        var id = eleTd && eleTd.getAttribute('data-id');
        if (!id || !/td/.test(eleTd.tagName)) { return; }
        
        // 这是要替换的数据
        var data = {
            id: id * 1    
        };
        // 获得现在的数据
        [].slice.call(eleTd.parentElement.querySelectorAll('td[data-key]')).forEach(function (td) {
            var key = td.getAttribute('data-key');
            var value = td.innerText || td.textContent || '';
            
            data[key] = value;
        });
        
        // 更新本地数据库
        editData(id, data);
    });
</script>

<script type="text/javascript">
	// “更换或对翻情况”单选项的监听器
	document.getElementById("replacement_1").addEventListener("click", function() {
		formShow(gh1);
	});
	document.getElementById("replacement_2").addEventListener("click", function() {
		formHidden(gh1);
	});
	document.getElementById("replacement_3").addEventListener("click", function() {
		formHidden(gh1);
	});
	formHidden
</script>

</html>