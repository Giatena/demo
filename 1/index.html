<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>电子工单（实验性）</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

	<script type="text/javascript">

	// jQuery 事件的 $(document).ready() --> DOM 就绪时被调用，此时相关资源可能并未加载完毕
	$(document).ready(function() {
		// 检查旧离线会话的 Web 缓存
		if(localStorage.formValues) {
			console.log("localStorage.formValues: "+ localStorage.formValues);
			postForm($("#web-storage-form").attr('action'), localStorage.formValues);
			localStorage.removeItem("formValues");
		}
		
		// jQuery：点击 id=web-storage-form 的 submit 按钮，执行 function
		$("#web-storage-form").submit(function(event) {

			// Prevent the form from posting
			event.preventDefault(); 
			
			// Gather values
			var formValues = $(this).serialize();
			var url = $(this).attr('action');
			postForm(url, formValues);
		});
	});
	
	// 完全加载完毕时调用
	window.onload = function(){
		showTime();

		// IndexedDB 支持检测
		var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.msIndexedDB;
		if(indexedDB){
			console.log("浏览器支持IndexedDB");
		}
		else {
			// 弹窗警告
			alert("您的浏览器不支持IndexedDB，可能会影响页面功能。请更新版本或改用支持的浏览器访问，谢谢");
		}
	}

	function showTime() {
		var date = new Date();
		var Y = date.getFullYear();
		var M = date.getMonth() + 1			// 由于月份是从0开始计算，所以要加1
		var D = date.getDate();
		var h = date.getHours();
		var m = date.getMinutes();
		var s = date.getSeconds();
		var ms = date.getMilliseconds();	// 取毫秒数（3位）

		if(M < 10) {M = '0'+ M;}			// 当数值为个位数时，在前面加0
		if(D < 10) {D = '0'+ D;}
		if(h < 10) {h = '0'+ h;}
		if(m < 10) {m = '0' + m;}
		if(s < 10) {s = '0' + s;}
		if(ms < 100) {ms = '0' + ms;}

		// console.log(ms);
		// console.log(Year +"." + Month + "." + Dates +" " + Hour+ ":" + Minute + ":" + Second);
		document.getElementById('dateTime').innerHTML = Y + "." + M + "." + D + " " + h + ":" + m + ":" + s + " " + ms;
		document.getElementById('GUID').value = Y + M + D + h + m + s + ms;

		setTimeout('showTime()', 1000);		// 每隔1秒运行一次 showTime()，即获取当前时间戳
	}

	function postForm(url, formValues) {
		// 表单数据提交服务器或缓存到 localStorage
		if(navigator.onLine) {
			console.log("Online");
	    	$.post(url, formValues, function(data) {
				console.log("Success: "+ data);
			});
		}
		else {
			console.log("Offline");
			if(typeof(Storage) !== "undefined") {
				console.log("Storage supported");
				localStorage.formValues = formValues;
			}
		}
	}

	$.fn.serializeObject = function(formJson) {
		var o = {};
		var a = this.serializeArray();
		$.each(a, function() {
			if (o[this.name] !== undefined) {
				if (!o[this.name].push) {
					o[this.name] = [o[this.name]];
				}
				o[this.name].push(this.value || '');
			} else {
				o[this.name] = this.value || '';
			}
		});
		return o;
	};

	// 参数为:数据库名和版本号。数据库存在则打开,否则创建。
	function createDatabase(dbName, version) {
		var openRequest = window.indexedDB.open(dbName, version);
		// request 返回一个 IDBOpenDBRequest 对象
		// 而我们期望得到的DB对象在其result属性中
		console.log(openRequest);

		openRequest.onerror = function(err) {
			console.log("创建数据库错误: " + err.target.errorCode);
		};

		openRequest.onsuccess = function(success) {
			console.log(JSON.stringify(success));
			console.log("数据库已打开: " + success.target.result);
			// 获取数据库实例对象 db
			var db = success.target.result;
		};

		openRequest.onupgradeneeded = function(event) {
			console.log(JSON.stringify(event));
			console.log('数据库版本有变化...');
			var db = event.target.result;
			var objectStore;
			// 如果不存在，则新建一张名为“CW”的表，主键是“id”
			if (!db.objectStoreNames.contains('CW')) {
				objectStore = db.createObjectStore('CW', );
			}
			return db;
		};
	}

	// 新增数据
	// 数据库名称,对象仓库（表名）,传入的参数
	function insert(dbName, version, objectStoreName, argument) {
		var db = createDatabase(dbName, version);
			console.log("运行到这里2");
			// 获取数据库实例对象 db
			var db = success.target.result;
			// 对某个表 进行事务操作的事务权限控制 
			var transaction = db.transaction(objectStoreName, 'readwrite');
			// 对表进行操作
			var objectStore = transaction.objectStore(objectStoreName);
			console.log(argument);
			// 使用add方法,此方法是异步的。有success,error事件
			var add = objectStore.add(argument);

			// 添加成功的回调函数
			add.onsuccess = function(e) {
				console.log(e);
				// console.log('向表[' + objectStoreName + ']新增一条数据为[' + argument + ']成功！！');
			}
			add.error = function(e) {
				// console.log('向表[' + objectStoreName + ']新增一条数据为[' + argument + ']失败！！');
			}
		}

	function writeIDB() {
		// serializeObject() 自定义函数可以一劳永逸地解决“serialize()返回不是json数组”和“url化后的中文乱码”的问题
		var formJson = JSON.stringify($("#web-storage-form").serializeObject());
		console.log("form数据序列化为json对象：" + formJson);

		// var db = createDatabase('Tickets', 2);

		var stu1 = {name: '欧可乐', age: 19, sex: '男'};

		insert('Tickets', 2, 'CW', stu1);
	}

	</script>

	<style type="text/css">
	label, 
	/*
	input {
		// 将每个元素置于一个新行。不启用本参数时，可利用 <br> 换行
		display: block;
	}
	*/
	input {
		/*在条目之间创建空间，让页面看起来不会太乱*/
		margin-bottom: 10px;
	}
	</style>

</head>

<body>

<!-- 表单传送到服务器的"post.php" -->
<form action="post.php" method="post" id="web-storage-form">

	<div id="dateTime"></div>
	<br>

	<!-- 获取模糊地理位置，本地日期和拉取服务器工单列表数据，自动生成提示性工单号。并提供一键填入的按钮 -->
	<input type="hidden" name="GUID" id="GUID">

	<label for="ticket">质保工单：</label>
	<input type="text" name="ticket" id="ticket" placeholder="日期CW_基地_序号">
	<br>

	<label for="train">列车编号：</label>
	<input type="text" name="train" id="train">
	<br>
    
	<label for="compartment">车厢编号：</label>
	<input type="text" name="compartment" id="compartment">
	<br>
    
	<label for="category">故障类别：</label>
	<input type="radio" value="1" name="category" id="category">
	<label>辅逆</label>
	<input type="radio" value="2" name="category" id="category">
	<label>牵引</label>
	<input type="radio" value="3" name="category" id="category">
	<label>列控</label>
	<br>

	<label for="type">故障级别：</label>
	<input type="radio" value="1" name="type" id="type">
	<label>救援</label>
	<input type="radio" value="2" name="type" id="type">
	<label>清客</label>
	<input type="radio" value="3" name="type" id="type">
	<label>掉线</label>
	<input type="radio" value="4" name="type" id="type">
	<label>换表</label>
	<input type="radio" value="5" name="type" id="type">
	<label>无影响</label>
	<input type="radio" value="6" name="type" id="type">
	<label>均修</label>
	<br>

	<!-- web访问，默认宽度；手机访问，自动适配；rows="2" 默认1行，再增加2行 -->
	<label for="description">故障现象：</label>
	<textarea name="description" id="description" cols="80" rows="2"></textarea>
	<br>

	<label for="action">处理经过：</label>
	<textarea name="action" id="action" cols="80" rows="5"></textarea>
	<br>

	<label for="replacement">更换或对翻情况：</label>
	<input type="radio" value="1" name="replacement" id="replacement" checked />
	<label>更换</label>
	<input type="radio" value="2" name="replacement" id="replacement">
	<label>对翻</label>
	<input type="radio" value="3" name="replacement" id="replacement">
	<label>无坏件</label>
	<br>

	<input type="submit" value="提交">
	<br>
	<input type="reset" value="重置">
	<br>
	<input type="button" value="缓存" id="idb" onclick="writeIDB()">
	<br>
	
</form>

</body>
</html>