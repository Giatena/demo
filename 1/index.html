<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>HTML5 Web Storage</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <script type="text/javascript">
    // IndexedDB 支持检测
	var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.msIndexedDB;
	if(indexedDB){
		console.log("浏览器支持IndexedDB");
	}
	else {
		// 弹窗警告
		alert("您的浏览器不支持IndexedDB，可能会影响页面功能。请更新版本或改用支持的浏览器访问，谢谢");
	}

	// jQuery 事件的 $(document).ready() --> DOM 就绪时被调用，此时相关资源可能并未加载完毕
	$(document).ready(function() {
		// 检查旧离线会话的 Web 缓存
		if(localStorage.formValues) {
			console.log("localStorage.formValues: "+ localStorage.formValues);
			postForm($("#web-storage-form").attr('action'), localStorage.formValues);
			localStorage.removeItem("formValues");
		}
		
		// jQuery：点击 id=web-storage-form 的 submit 按钮，执行 function
		$("#web-storage-form").submit(function(event) {

			// Prevent the form from posting
			event.preventDefault(); 
			
			// Gather values
			var formValues = $(this).serialize();
			var url = $(this).attr('action');
			postForm(url, formValues);
		});
	});
	
	function postForm(url, formValues) {
		// 表单数据提交服务器或缓存到 localStorage
		if(navigator.onLine) {
			console.log("Online");
	    	$.post(url, formValues, function(data) {
				console.log("Success: "+ data);
			});
		}
		else {
			console.log("Offline");
			if(typeof(Storage) !== "undefined") {
				console.log("Storage supported");
				localStorage.formValues = formValues;
			}
		}
	}

	function writeIDB() {
		// form 表单封装到 FormData 对象，二合一语句 --> var formData = new FormData(document.getElementById("web-storage-form"));

		// 获取 id="web-storage-form" 的 form 表单
		var formElement = document.getElementById("web-storage-form");
		// 用 form 初始化 FormData 对象
		var newFormData = new FormData(formElement);
		console.log(formElement);

		// var objArr = JSON.serialize($('web-storage-form').serializeArray());
		// var obj = objArr.pop();
		// var strJson = JSON.serialize(obj);
		// console.log(strJson);
		var serializeUrl = $("#web-storage-form").serializeArray()
		console.log("序列化为url格式为：" + serializeUrl);
		// console.log(formJSON);

		// $('#web-storage-form').serializeArray()
	}

	</script>

    <style type="text/css">
	label, 
	/*
	input {
		// 将每个元素置于一个新行。不启用本参数时，可利用 <br> 换行
		display: block;
	}
	*/
	input {
		/*在条目之间创建空间，让页面看起来不会太乱*/
		margin-bottom: 10px;
	}
	</style>

</head>

<body>

<!-- 表单传送到服务器的"post.php" -->
<form action="post.php" method="post" id="web-storage-form">

	<label for="cw-order">质保工单：</label>
	<input type="text" name="cw-order" id="cw-order">
	<br>

	<label for="train-number">列车编号：</label>
	<input type="text" name="train-number" id="train-number">
	<br>
    
	<label for="compartment-number">车厢编号：</label>
	<input type="text" name="compartment-number" id="compartment-number">
	<br>
    
	<label for="fault-category">故障类别：</label>
    <label>辅逆</label>
    <input type="radio" value="1" name="fault-category" id="fault-category">
    <label>牵引</label>
    <input type="radio" value="2" name="fault-category" id="fault-category">
    <label>列控</label>
    <input type="radio" value="3" name="fault-category" id="fault-category">
    <br>

	<!--
	<label for="fault-category">故障类别：</label>
	<input type="text" name="fault-category" id="fault-category">
	-->

	<label for="fault-type">故障级别：</label>
	<input type="text" name="fault-type" id="fault-type">
	<br>
    
	<input type="submit" value="提交">
	<br>
	<input type="reset" value="重置">
	<br>
	<input type="button" value="缓存" id="idb" onclick="writeIDB()">

</form>

</body>
</html>