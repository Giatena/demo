<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>HTML5 Web Storage</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <script type="text/javascript">
	$(document).ready(function() {
		// 检查旧离线会话的 Web 缓存
		if(localStorage.formValues) {
			console.log("localStorage.formValues: "+ localStorage.formValues);
			postForm($("#web-storage-form").attr('action'), localStorage.formValues);
			localStorage.removeItem("formValues");
		}
		
		$("#web-storage-form").submit(function(event) {
			// Prevent the form from posting
			event.preventDefault(); 
			
			// Gather values
			var formValues = $(this).serialize();
			var url = $(this).attr('action');
			postForm(url, formValues);
		});
	});
		
	function postForm(url, formValues) {
		// 提交到服务器或保存到 Web 缓存（web storage）
		if(navigator.onLine) {
			console.log("Online");
			$.post(url, formValues, function(data) {
				console.log("Success: "+ data);
			});
		}
		else {
			console.log("Offline");
			if(typeof(Storage) !== "undefined") {
				console.log("Storage supported");
				localStorage.formValues = formValues;
			}
		}

		// 当网络状态发生变化时，浏览器通过以上监听函数可捕获到网络的状态（Chrome59/Firefox54/IE Edge均测试通过）
		window.addEventListener('online',  function(){
			alert("window.addEventListener: onLine");
		});

		window.addEventListener('offline', function(){
			alert("window.addEventListener: offLine");
		});

	}

	</script>

    <style type="text/css">
	label, 
	input {
		display: block;
	}
	input {
		margin-bottom: 10px;
	}
	</style>

</head>

<body>

<form action="post.php" method="post" id="web-storage-form">

	<label for="cw-order">质保工单：</label>
	<input type="text" name="cw-order" id="cw-order">

	<label for="train-number">列车编号：</label>
	<input type="text" name="train-number" id="train-number">
    
	<label for="compartment-number">车厢编号：</label>
	<input type="text" name="compartment-number" id="compartment-number">
    
	<label for="fault-category">故障类别：</label>
	<input type="text" name="fault-category" id="fault-category">

	<label for="fault-type">故障级别：</label>
	<input type="text" name="fault-type" id="fault-type">
    
	<input type="submit" value="存入IDB并异步提交">

</form>

</body>
</html>