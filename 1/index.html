<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>HTML5 Web Storage</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    <script type="text/javascript">
    // IndexedDB 支持检测
	var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.msIndexedDB;
	if(indexedDB){
		console.log("浏览器支持 IndexedDB");
	}
	else {
		// 弹窗警告
		alert("您的浏览器不支持IndexedDB，可能会影响页面功能。请更新版本或改用支持的浏览器访问，谢谢");
	}

	// jQuery 事件的 $(document).ready() --> DOM 就绪时被调用，此时相关资源可能并未加载完毕
	$(document).ready(function() {
		// 检查旧离线会话的 Web 缓存
		if(localStorage.formValues) {
			console.log("localStorage.formValues: "+ localStorage.formValues);
			postForm($("#web-storage-form").attr('action'), localStorage.formValues);
			localStorage.removeItem("formValues");
		}
		
		$("#web-storage-form").submit(function(event) {

			console.log("运行到“提交”按钮的方法里");

			// Prevent the form from posting
			event.preventDefault(); 
			
			// Gather values
			var formValues = $(this).serialize();
			var url = $(this).attr('action');
			postForm(url, formValues);
		});
	});
	
	function postForm(url, formValues) {
		// 表单数据提交服务器或缓存到 localStorage
		if(navigator.onLine) {
			console.log("Online");
	    	$.post(url, formValues, function(data) {
				console.log("Success: "+ data);
			});
		}
		else {
			console.log("Offline");
			if(typeof(Storage) !== "undefined") {
				console.log("Storage supported");
				localStorage.formValues = formValues;
			}
		}

	</script>

    <style type="text/css">
	label, 
	input {
		/* 将每个元素置于一个新行 */
		display: block;
	}
	input {
		/*在条目之间创建空间，让页面看起来不会太乱*/
		margin-bottom: 10px;
	}
	</style>

</head>

<body>

<form action="post.php" method="post" id="web-storage-form">

	<label for="cw-order">质保工单：</label>
	<input type="text" name="cw-order" id="cw-order">

	<label for="train-number">列车编号：</label>
	<input type="text" name="train-number" id="train-number">
    
	<label for="compartment-number">车厢编号：</label>
	<input type="text" name="compartment-number" id="compartment-number">
    
	<label for="fault-category">故障类别：</label>
    <label>辅逆</label>
    <input type="radio" value="1" name="fault-category" id="fault-category">
    <label>牵引</label>
    <input type="radio" value="2" name="fault-category" id="fault-category">
    <label>列控</label>
    <input type="radio" value="3" name="fault-category" id="fault-category">

	<!--
	<label for="fault-category">故障类别：</label>
	<input type="text" name="fault-category" id="fault-category">
	-->

	<label for="fault-type">故障级别：</label>
	<input type="text" name="fault-type" id="fault-type">
    
	<input type="submit" value="存入IDB并异步提交">
	<input type="reset" value="重置">

</form>

</body>
</html>